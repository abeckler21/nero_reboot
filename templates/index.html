<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NERO Interactive Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      --panel-padding: 20px;
    }

    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background-color: #fafafa;
      margin: 0;
      padding: var(--panel-padding);
      height: 100vh;
      overflow: hidden;
      box-sizing: border-box;
    }

    /* Left: PCA plot container */
    #pca-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      margin-right: var(--panel-padding);
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 10px;
      box-sizing: border-box;
    }

    #pca {
      flex: 1;
      width: 100%;
    }

    /* Legend styling */
    #legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: center;
      gap: 8px 12px;
      margin-top: 6px;
      padding: 5px 10px;
      border-top: 1px solid #ddd;
      font-size: 13px;
      overflow-y: auto;
      max-height: 70px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #444;
    }

    /* Right: NERO image panel */
    #nero-panel {
      width: 45%;
      text-align: center;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100%;
      box-sizing: border-box;
    }

    #nero-img {
      width: 90%;
      max-width: 480px;
      height: auto;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #ccc;
    }

    h2 {
      margin-bottom: 5px;
    }

    @media (max-width: 1000px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      #pca-container, #nero-panel {
        width: 95%;
        margin-bottom: 20px;
        height: 80vh;
      }
      #legend {
        max-height: 60px;
      }
    }
  </style>
</head>

<body>
  <!-- Left: PCA Scatter and Key -->
  <div id="pca-container">
    <div id="pca"></div>
    <div id="legend"></div>
  </div>

  <!-- Right: NERO Image Panel -->
  <div id="nero-panel">
    <h2>NERO Panel</h2>
    <img id="nero-img" src="" alt="NERO plot will appear here">
  </div>

  <script>
    // ===== Load PCA data from Flask =====
    const data = {{ data | safe }};

    // ===== Generate discrete color palette =====
    const uniqueLabels = [...new Set(data.map(d => d.label))].sort();
    const palette = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
      "#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78",
      "#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7",
      "#dbdb8d","#9edae5","#393b79","#637939","#8c6d31","#843c39",
      "#7b4173"
    ];

    // Assign each label a color
    const labelToColor = {};
    uniqueLabels.forEach((lbl, i) => {
      labelToColor[lbl] = palette[i % palette.length];
    });
    const colors = data.map(d => labelToColor[d.label]);

    // ===== Configure PCA Scatter =====
    const trace = {
      x: data.map(d => d.x),
      y: data.map(d => d.y),
      mode: 'markers',
      type: 'scatter',
      name: 'PCA samples',
      text: data.map(d => `Sample ${d.idx}<br>Label ${d.label}`),
      hoverinfo: 'text',
      marker: {
        color: colors,
        size: 7,
        line: { width: 0.5, color: '#333' }
      }
    };

    const layout = {
      title: { text: 'Feature PCA (Click a point to view NERO)', font: { size: 20 } },
      hovermode: 'closest',
      xaxis: { title: 'PCA Dimension 1', zeroline: false },
      yaxis: { title: 'PCA Dimension 2', zeroline: false },
      margin: { l: 60, r: 60, t: 60, b: 60 },
      plot_bgcolor: '#fff',
      paper_bgcolor: '#fff',
      showlegend: false,
    };

    const config = { responsive: true, displaylogo: false };

    // ===== Render PCA plot =====
    Plotly.newPlot('pca', [trace], layout, config);

    // ===== Create Legend (Key) =====
    const legendDiv = document.getElementById("legend");
    uniqueLabels.forEach(lbl => {
      const item = document.createElement("div");
      item.className = "legend-item";
      const colorBox = document.createElement("div");
      colorBox.className = "legend-color";
      colorBox.style.backgroundColor = labelToColor[lbl];
      const labelText = document.createElement("span");
      labelText.textContent = lbl;
      item.appendChild(colorBox);
      item.appendChild(labelText);
      legendDiv.appendChild(item);
    });

    // ===== Click handler for PCA points =====
    document.getElementById('pca').on('plotly_click', function(event) {
      const idx = event.points[0].pointIndex;
      const imgTag = document.getElementById('nero-img');
      imgTag.src = "";
      imgTag.alt = "Generating NERO plot...";

      fetch('/get_nero', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx })
      })
      .then(res => res.json())
      .then(json => {
        imgTag.src = "data:image/png;base64," + json.image;
        imgTag.alt = `Sample ${json.sample} (Label ${json.label})`;
      })
      .catch(err => {
        console.error("Error fetching NERO data:", err);
        imgTag.alt = "Error generating NERO plot.";
      });
    });

    // ===== Auto-resize PCA plot with window =====
    window.addEventListener('resize', () => {
      Plotly.Plots.resize('pca');
    });
  </script>
</body>
</html>
