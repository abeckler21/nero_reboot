<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NERO Interactive Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      --border-color: #ddd;
      --bg-light: #fafafa;
      --accent-blue: #007bff;
    }

    /* --- Reset & base --- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background-color: var(--bg-light);
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      overflow: hidden;
    }

    /* --- Main layout container --- */
    #dashboard {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      height: 100vh; /* full viewport height */
      box-sizing: border-box;
    }

    /* --- Left: PCA plot container --- */
    #pca-container {
      flex: 0 0 60%;
      height: 100%;
      padding: 0.75rem;
      box-sizing: border-box;
      background: #fff;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* PCA + legend side by side */
    #pca-wrapper {
      display: flex;
      flex-direction: row;
      flex: 1;
      align-items: stretch;
    }

    /* Main PCA plot (85%) */
    #pca {
      flex: 1 1 85%;
      height: 100%;
    }

    /* Legend on the right (15%) */
    #legend {
      flex: 0 0 15%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding-left: 10px;
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      background-color: #fff;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #444;
    }

    /* Slider controls below PCA */
    #pca-controls {
      margin-top: 10px;
      padding: 8px;
      background-color: #f8f9fa;
      border-top: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    #pca-slider {
      width: 100%;
      margin-top: 4px;
    }

    /* --- Right: NERO / ICE diagnostics panel --- */
    #nero-panel {
      flex: 0 0 40%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-y: auto;
      padding: 0.75rem;
      box-sizing: border-box;
      background-color: var(--bg-light);
    }

    h2 {
      margin: 10px 0 5px;
      text-align: center;
    }

    /* --- Toggle buttons --- */
    #view-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    #view-buttons button {
      background-color: #e9ecef;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s ease-in-out;
    }

    #view-buttons button:hover {
      background-color: #dce3ea;
    }

    #view-buttons button.active {
      background-color: var(--accent-blue);
      color: white;
      font-weight: bold;
      border-color: var(--accent-blue);
    }

    /* --- Diagnostic image scaling --- */
    #diagnostic-img {
      max-width: 95%;
      max-height: 85vh;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 0.5rem;
    }

    /* --- Responsive layout --- */
    @media (max-width: 1000px) {
      #dashboard {
        flex-direction: column;
        align-items: center;
        height: auto;
        overflow-y: auto;
      }

      #pca-container, #nero-panel {
        width: 95%;
        margin-bottom: 20px;
        height: 80vh;
      }

      #pca-wrapper {
        flex-direction: column;
      }

      #legend {
        flex-direction: row;
        flex-wrap: wrap;
        border-left: none;
        border-top: 1px solid var(--border-color);
        padding-top: 6px;
        padding-left: 0;
      }

      #pca {
        height: 70vh;
      }
    }
  </style>
</head>

<body>
  <div id="dashboard">
    <!-- Left: PCA Scatter + legend + slider -->
    <div id="pca-container">
      <div id="pca-wrapper">
        <div id="pca"></div>
        <div id="legend"></div>
      </div>
      <div id="pca-controls">
        <label for="pca-slider">
          <strong>Number of PCA Components:</strong>
          <span id="pca-value">2</span>
        </label>
        <input type="range" id="pca-slider" min="2" max="50" value="2" step="1">
      </div>
    </div>

    <!-- Right: NERO Image Panel -->
    <div id="nero-panel">
      <h2>Model Diagnostics</h2>
      <div id="view-buttons">
        <button id="btn-nero" class="active">NERO</button>
        <button id="btn-ice">ICE</button>
        <button id="btn-hist">Conf. Hist.</button>
      </div>
      <img id="diagnostic-img" src="" alt="Diagnostic plot will appear here">
    </div>
  </div>

  <script>
    // ===== Load PCA data from Flask =====
    const data = {{ data | safe }};

    // ===== Generate discrete color palette =====
    const uniqueLabels = [...new Set(data.map(d => d.label))].sort();
    const palette = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
      "#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78",
      "#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7",
      "#dbdb8d","#9edae5","#393b79","#637939","#8c6d31","#843c39","#7b4173"
    ];

    const labelToColor = {};
    uniqueLabels.forEach((lbl, i) => { labelToColor[lbl] = palette[i % palette.length]; });
    const colors = data.map(d => labelToColor[d.label]);

    // ===== Configure PCA Scatter =====
    const trace = {
      x: data.map(d => d.x),
      y: data.map(d => d.y),
      mode: 'markers',
      type: 'scatter',
      name: 'PCA samples',
      text: data.map(d => `Sample ${d.idx}<br>Label ${d.label}`),
      hoverinfo: 'text',
      marker: { color: colors, size: 7, line: { width: 0.5, color: '#333' } }
    };

    const layout = {
      title: { text: 'Feature PCA (Click a point to view NERO / ICE)', font: { size: 20 } },
      hovermode: 'closest',
      xaxis: { title: 'PCA Dimension 1', zeroline: false },
      yaxis: { title: 'PCA Dimension 2', zeroline: false },
      margin: { l: 60, r: 60, t: 60, b: 60 },
      plot_bgcolor: '#fff',
      paper_bgcolor: '#fff',
      showlegend: false,
    };

    const config = { responsive: true, displaylogo: false };
    Plotly.newPlot('pca', [trace], layout, config);

    // ===== Dynamic PCA dimension slider =====
    const slider = document.getElementById("pca-slider");
    const pcaValue = document.getElementById("pca-value");

    slider.addEventListener("input", function() {
      pcaValue.textContent = slider.value;
    });

    slider.addEventListener("change", function() {
      const dims = parseInt(slider.value);
      fetch("/get_pca_dim", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dims: dims })
      })
      .then(res => res.json())
      .then(newData => {
        const updatedTrace = {
          x: newData.map(d => d.x),
          y: newData.map(d => d.y),
          mode: 'markers',
          type: 'scatter',
          text: newData.map(d => `Sample ${d.idx}<br>Label ${d.label}`),
          hoverinfo: 'text',
          marker: {
            color: newData.map(d => labelToColor[d.label]),
            size: 7,
            line: { width: 0.5, color: '#333' }
          }
        };
        Plotly.react('pca', [updatedTrace], layout, config);
      })
      .catch(err => console.error("Error updating PCA:", err));
    });

    // ===== Create Legend (Key) =====
    const legendDiv = document.getElementById("legend");
    uniqueLabels.forEach(lbl => {
      const item = document.createElement("div");
      item.className = "legend-item";
      const colorBox = document.createElement("div");
      colorBox.className = "legend-color";
      colorBox.style.backgroundColor = labelToColor[lbl];
      const labelText = document.createElement("span");
      labelText.textContent = lbl;
      item.appendChild(colorBox);
      item.appendChild(labelText);
      legendDiv.appendChild(item);
    });

    // ===== Global state =====
    let currentMode = "nero";
    let lastSelectedIndex = null;
    const neroBtn = document.getElementById("btn-nero");
    const iceBtn = document.getElementById("btn-ice");
    const histBtn = document.getElementById("btn-hist");
    const imgTag = document.getElementById('diagnostic-img');

    // ===== Helper to fetch and display a plot =====
    function fetchPlot(index, mode) {
      if (index === null) return;

      imgTag.src = "";
      imgTag.alt = `Generating ${mode.toUpperCase()} plot...`;

      // Select correct backend route
      let endpoint;
      if (mode === "nero") endpoint = "get_nero";
      else if (mode === "ice") endpoint = "get_ice";
      else if (mode === "confidence_hist") endpoint = "get_confidence_hist";
      else return console.error("Unknown mode:", mode);

      // Fetch and render the image
      fetch(`/${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index: index })
      })
        .then(res => res.json())
        .then(json => {
          imgTag.src = "data:image/png;base64," + json.image;
          imgTag.alt = `${mode.toUpperCase()} plot for Sample ${json.sample} (Label ${json.label})`;
        })
        .catch(err => {
          console.error("Error fetching plot:", err);
          imgTag.alt = "Error generating plot.";
        });
    }

    // ===== Button Toggles =====
    neroBtn.onclick = () => {
      currentMode = "nero";
      neroBtn.classList.add("active");
      iceBtn.classList.remove("active");
      if (lastSelectedIndex !== null) fetchPlot(lastSelectedIndex, "nero");
    };

    iceBtn.onclick = () => {
      currentMode = "ice";
      iceBtn.classList.add("active");
      neroBtn.classList.remove("active");
      if (lastSelectedIndex !== null) fetchPlot(lastSelectedIndex, "ice");
    };

    histBtn.onclick = () => {
      currentMode = "confidence_hist";
      [neroBtn, iceBtn, histBtn].forEach(btn => btn.classList.remove("active"));
      histBtn.classList.add("active");
      if (lastSelectedIndex !== null) {
        fetchPlot(lastSelectedIndex, "confidence_hist");
      } else {
        imgTag.alt = "Please select a sample point first.";
      }
    };

    // ===== Click handler for PCA points =====
    document.getElementById('pca').on('plotly_click', function(event) {
      const idx = event.points[0].pointIndex;
      lastSelectedIndex = idx;
      fetchPlot(idx, currentMode);
    });

    // ===== Auto-resize PCA plot with window =====
    window.addEventListener('resize', () => {
      Plotly.Plots.resize('pca');
    });
  </script>
</body>
</html>
